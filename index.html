<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Audio Visualizer - Blue Neon</title>
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        /* Basic CSS to ensure the scene fills the entire browser window. */
        body { margin: 0; }
        canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <!-- 
      ============================================================
      A-FRAME SCENE SETUP
      ============================================================
    -->
    <a-scene id="main-scene" background="color: #000">
        <!-- Assets: Not used in this version, but good practice to include. -->
        <a-assets></a-assets>

        <!-- 
          CAMERA AND CURSOR
          The camera is the user's viewpoint. The cursor provides a reticle 
          and enables click interactions with objects in the scene.
        -->
        <a-camera>
            <a-cursor></a-cursor>
        </a-camera>

        <!-- 
          THE CUBE ROOM - "SHADES OF BLUE" VIBE
          The room is constructed from six <a-plane> entities, each acting as a wall.
          Each wall has a distinct, harmonious shade of blue for depth and orientation.
          Dimensions are 10x10 units.
        -->
        <!-- Floor (Dark Navy) -->
        <a-plane position="0 -5 0" rotation="-90 0 0" width="10" height="10" color="#001f3f"></a-plane>
        <!-- Ceiling (Light Aqua) -->
        <a-plane position="0 5 0" rotation="90 0 0" width="10" height="10" color="#7FDBFF"></a-plane>
        <!-- Back Wall (Primary Blue) -->
        <a-plane position="0 0 5" rotation="0 180 0" width="10" height="10" color="#0074D9"></a-plane>
        <!-- Left Wall (Teal) -->
        <a-plane position="-5 0 0" rotation="0 90 0" width="10" height="10" color="#39CCCC"></a-plane>
        <!-- Right Wall (Deep Sky Blue) -->
        <a-plane position="5 0 0" rotation="0 -90 0" width="10" height="10" color="#00BFFF"></a-plane>
        
        <!-- 
          FRONT WALL (VISUALIZER HOST)
          This wall has a very dark blue background to provide good contrast for the neon orange bars.
        -->
        <a-plane id="visualizer-wall" position="0 0 -5" width="10" height="10" color="#001020"></a-plane>

        <!-- 
          AUDIO VISUALIZER BARS CONTAINER
          This entity will hold the dynamically generated bars. It's positioned slightly in front 
          of the wall to prevent z-fighting (visual flickering).
        -->
        <a-entity id="visualizer-bars-container" position="0 0 -4.95"></a-entity>

        <!-- 
          INTERACTION & UI
        -->
        <!-- Start Button (Bright Yellow for contrast) -->
        <a-entity id="start-button" position="0 1.6 -3" 
                  geometry="primitive: sphere; radius: 0.3;" 
                  material="color: #FFDC00; shader: flat;"
                  animation__scale="property: scale; to: 1.1 1.1 1.1; dur: 200; startEvents: mouseenter"
                  animation__scale_reverse="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
            <a-text value="Start Visualizer" align="center" position="0 0.5 0" width="3" color="black"></a-text>
        </a-entity>

        <!-- Status/Error Message Text -->
        <a-text id="status-text" value="" align="center" position="0 2.5 -4" color="white" width="6" visible="false"></a-text>

    </a-scene>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // ============================================================
        // VARIABLE DECLARATIONS
        // ============================================================
        const startButton = document.getElementById('start-button');
        const statusText = document.getElementById('status-text');
        const barsContainer = document.getElementById('visualizer-bars-container');
        
        // Web Audio API variables
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;

        // Visualizer variables
        let visualizerBars = [];
        const NUM_BARS = 32; // The number of visualizer bars to create.

        // ============================================================
        // VISUALIZER SETUP
        // ============================================================

        /**
         * Creates the visualizer bars with a neon/glowing style and adds them to the scene.
         */
        function createVisualizerBars() {
            // The total width should match the wall's width.
            const totalWidth = 9.8; 
            const barWidth = totalWidth / NUM_BARS;
            const gap = barWidth * 0.15; // A small gap between bars.
            const effectiveBarWidth = barWidth - gap;

            for (let i = 0; i < NUM_BARS; i++) {
                const bar = document.createElement('a-box');
                const xPosition = -totalWidth / 2 + i * barWidth + barWidth / 2;
                
                bar.setAttribute('position', `${xPosition} 0 0`);
                bar.setAttribute('width', effectiveBarWidth);
                bar.setAttribute('depth', 0.2);
                bar.setAttribute('height', 0.1); // Initial small height.
                
                // STYLISTIC CHANGE: Use a flat shader with an emissive color to create a neon glow effect.
                // This makes the bars look like they are emitting light.
                bar.setAttribute('material', {
                    shader: 'flat',
                    color: '#FFA500', // Vibrant orange
                    emissive: '#FFA500',
                    emissiveIntensity: 1.5
                });
                
                barsContainer.appendChild(bar);
                visualizerBars.push(bar);
            }
        }

        // ============================================================
        // WEB AUDIO API INITIALIZATION
        // ============================================================

        /**
         * Initializes the Web Audio API and requests microphone access.
         * This function is triggered by the user clicking the start button.
         */
        async function initAudio() {
            console.log('Attempting to start or resume audio...');

            // BUG FIX ATTEMPT: Check if the AudioContext is suspended, which can happen after 
            // entering immersive (VR) mode. If so, resume it. This requires a user gesture (the click).
            if (audioContext && audioContext.state === 'suspended') {
                console.log('Resuming suspended AudioContext.');
                await audioContext.resume();
            }

            // If the audio context doesn't exist yet, create and configure it.
            if (!audioContext) {
                console.log('Creating new AudioContext.');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;

                    microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);

                    const bufferLength = analyser.frequencyBinCount;
                    dataArray = new Uint8Array(bufferLength);
                    
                    // Hide the start button and show a success message only on the first successful connection.
                    startButton.setAttribute('visible', 'false');
                    statusText.setAttribute('value', 'Microphone Connected!');
                    statusText.setAttribute('visible', 'true');
                    setTimeout(() => statusText.setAttribute('visible', 'false'), 2000);

                    // Start the animation loop.
                    updateVisualizer();

                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    statusText.setAttribute('value', 'Microphone access denied.\nPlease allow access in browser settings.');
                    statusText.setAttribute('visible', 'true');
                    startButton.setAttribute('visible', 'false');
                }
            }
        }

        // ============================================================
        // VISUALIZER ANIMATION LOOP
        // ============================================================

        /**
         * This function runs on every frame to update the visualizer bars.
         */
        function updateVisualizer() {
            // This check ensures we don't try to animate if the audio setup failed.
            if (!analyser) {
                return;
            }

            requestAnimationFrame(updateVisualizer);
            analyser.getByteFrequencyData(dataArray);

            const sliceWidth = Math.floor(dataArray.length / NUM_BARS);

            for (let i = 0; i < NUM_BARS; i++) {
                let sliceStart = i * sliceWidth;
                let slice = dataArray.slice(sliceStart, sliceStart + sliceWidth);
                let averageVolume = slice.reduce((a, b) => a + b, 0) / slice.length;

                // Map the 0-255 volume range to a suitable height for the scene.
                // The max height is adjusted to fit the 10-unit high wall.
                const height = (averageVolume / 255) * 9.5 + 0.1;
                
                const bar = visualizerBars[i];
                if (bar) {
                    // Update height and position simultaneously.
                    bar.setAttribute('height', height);
                    bar.setAttribute('position', { y: height / 2 - 5, x: bar.getAttribute('position').x, z: 0 });
                }
            }
        }

        // ============================================================
        // EVENT LISTENERS & INITIALIZATION
        // ============================================================

        createVisualizerBars();
        startButton.addEventListener('click', initAudio);

    });
    </script>
</body>
</html>
