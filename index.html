<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Audio Visualizer</title>
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        /* Basic CSS to ensure the scene fills the entire browser window. */
        body { margin: 0; }
        canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <!-- 
      ============================================================
      A-FRAME SCENE SETUP
      This is the main container for all VR elements.
      ============================================================
    -->
    <a-scene id="main-scene">
        <!-- Assets: Not used in this version, but good practice to include. -->
        <a-assets></a-assets>

        <!-- 
          CAMERA AND CURSOR
          The camera is the user's viewpoint. The cursor provides a reticle 
          and enables click interactions with objects in the scene.
        -->
        <a-camera>
            <a-cursor></a-cursor>
        </a-camera>

        <!-- 
          THE CUBE ROOM
          The room is constructed from six <a-plane> entities, each acting as a wall.
          Each wall has a unique color for easy orientation. The user starts inside.
          Dimensions are 10x10 units.
        -->
        <!-- Floor -->
        <a-plane position="0 -5 0" rotation="-90 0 0" width="10" height="10" color="orange"></a-plane>
        <!-- Ceiling -->
        <a-plane position="0 5 0" rotation="90 0 0" width="10" height="10" color="purple"></a-plane>
        <!-- Back Wall -->
        <a-plane position="0 0 5" rotation="0 180 0" width="10" height="10" color="green"></a-plane>
        <!-- Left Wall -->
        <a-plane position="-5 0 0" rotation="0 90 0" width="10" height="10" color="blue"></a-plane>
        <!-- Right Wall -->
        <a-plane position="5 0 0" rotation="0 -90 0" width="10" height="10" color="red"></a-plane>
        
        <!-- 
          FRONT WALL (VISUALIZER HOST)
          This wall is intentionally separate so we can easily place the visualizer bars on it.
          It's positioned at z = -5, directly in front of the camera's starting point.
        -->
        <a-plane id="visualizer-wall" position="0 0 -5" width="10" height="10" color="#333333"></a-plane>

        <!-- 
          AUDIO VISUALIZER BARS
          These boxes will be manipulated by JavaScript to react to audio input.
          They are created dynamically by the script below.
        -->
        <a-entity id="visualizer-bars-container" position="0 0 -4.95"></a-entity>

        <!-- 
          INTERACTION & UI
          This section contains the button to start the experience and text for user feedback.
        -->
        <!-- Start Button -->
        <a-entity id="start-button" position="0 1.6 -3" geometry="primitive: sphere; radius: 0.3;" material="color: #4CC3D9"
                  animation__scale="property: scale; to: 1.1 1.1 1.1; dur: 200; startEvents: mouseenter"
                  animation__scale_reverse="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
            <a-text value="Start Visualizer" align="center" position="0 0.5 0" width="3"></a-text>
        </a-entity>

        <!-- Status/Error Message Text -->
        <a-text id="status-text" value="" align="center" position="0 2.5 -4" color="white" width="6" visible="false"></a-text>

    </a-scene>

    <script>
    // Wait until the entire HTML document is loaded before running the script.
    document.addEventListener('DOMContentLoaded', () => {
        
        // ============================================================
        // VARIABLE DECLARATIONS
        // ============================================================
        const startButton = document.getElementById('start-button');
        const statusText = document.getElementById('status-text');
        const barsContainer = document.getElementById('visualizer-bars-container');
        
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let visualizerBars = [];

        const NUM_BARS = 32; // The number of visualizer bars to create.

        // ============================================================
        // VISUALIZER SETUP
        // ============================================================

        /**
         * Creates the visualizer bars and adds them to the scene.
         */
        function createVisualizerBars() {
            const totalWidth = 8; // Total width the bars will occupy on the wall.
            const barWidth = totalWidth / NUM_BARS;
            const gap = barWidth * 0.2; // A small gap between bars.
            const effectiveBarWidth = barWidth - gap;

            for (let i = 0; i < NUM_BARS; i++) {
                const bar = document.createElement('a-box');
                const xPosition = -totalWidth / 2 + i * barWidth + barWidth / 2;
                
                bar.setAttribute('position', `${xPosition} 0 0`);
                bar.setAttribute('width', effectiveBarWidth);
                bar.setAttribute('depth', 0.2);
                bar.setAttribute('height', 0.1); // Initial small height.
                bar.setAttribute('color', '#FFC65D');
                
                barsContainer.appendChild(bar);
                visualizerBars.push(bar);
            }
        }

        // ============================================================
        // WEB AUDIO API INITIALIZATION
        // ============================================================

        /**
         * Initializes the Web Audio API and requests microphone access.
         * This function is triggered by the user clicking the start button.
         */
        async function initAudio() {
            console.log('Attempting to start audio...');
            try {
                // Request access to the user's microphone.
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                
                // Hide the start button and show a success message temporarily.
                startButton.setAttribute('visible', 'false');
                statusText.setAttribute('value', 'Microphone Connected!');
                statusText.setAttribute('visible', 'true');
                setTimeout(() => statusText.setAttribute('visible', 'false'), 2000);

                // Create and configure the AudioContext and AnalyserNode.
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256; // Determines the resolution of the frequency analysis.

                // Create a source from the microphone stream and connect it to the analyser.
                // We do NOT connect the analyser to the destination (speakers) to avoid feedback.
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                // Create an array to store the frequency data.
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                // Start the animation loop.
                updateVisualizer();

            } catch (err) {
                // Handle errors, especially if the user denies microphone permission.
                console.error('Error accessing microphone:', err);
                statusText.setAttribute('value', 'Microphone access denied.\nPlease allow microphone access in browser settings.');
                statusText.setAttribute('visible', 'true');
                startButton.setAttribute('visible', 'false'); // Hide button after attempt.
            }
        }

        // ============================================================
        // VISUALIZER ANIMATION LOOP
        // ============================================================

        /**
         * This function runs on every frame to update the visualizer bars.
         */
        function updateVisualizer() {
            // Schedule the next frame of the animation.
            requestAnimationFrame(updateVisualizer);

            // Get the frequency data from the analyser.
            analyser.getByteFrequencyData(dataArray);

            // Calculate how many data points each bar represents.
            const sliceWidth = Math.floor(dataArray.length / NUM_BARS);

            for (let i = 0; i < NUM_BARS; i++) {
                // Get the average volume for the segment of data corresponding to this bar.
                let sliceStart = i * sliceWidth;
                let sliceEnd = sliceStart + sliceWidth;
                let slice = dataArray.slice(sliceStart, sliceEnd);
                let averageVolume = slice.reduce((a, b) => a + b, 0) / slice.length;

                // Map the 0-255 volume range to a suitable height for the scene.
                // The base height is 0.1 so bars are always visible.
                // The multiplier (e.g., 8) controls the max height/sensitivity.
                const height = (averageVolume / 255) * 8 + 0.1;
                
                // Smoothly update the bar's height (y-scale).
                const bar = visualizerBars[i];
                const currentHeight = bar.getAttribute('height');
                
                // A-Frame's setAttribute handles the underlying 3D object update.
                // We also need to adjust the y-position so it grows upwards from the base.
                bar.setAttribute('height', height);
                bar.setAttribute('position', { y: height / 2, x: bar.getAttribute('position').x, z: 0 });
            }
        }

        // ============================================================
        // EVENT LISTENERS
        // ============================================================

        // Create the bars as soon as the script loads.
        createVisualizerBars();

        // Add a click event listener to the start button to trigger audio initialization.
        startButton.addEventListener('click', initAudio);

    });
    </script>
</body>
</html>
