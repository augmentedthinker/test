<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Floating Cube</title>
  <!-- Load Three.js -->
  <script src="https://unpkg.com/three@0.126.0/build/three.min.js"></script>
</head>
<body style="margin:0; overflow:hidden; background:#000;">
  <button id="ar-btn" style="position:fixed;top:20px;left:20px;z-index:10;padding:12px 24px;font-size:1.2em;">Start AR</button>
  <script>
    let xrSession = null;
    let renderer, scene, camera, cube;
    let refSpace;

    document.getElementById('ar-btn').onclick = activateXR;

    async function activateXR() {
      if (!navigator.xr) {
        alert("WebXR is not supported on this browser.");
        return;
      }
      try {
        xrSession = await navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['local'] });
      } catch (e) {
        alert("Failed to start AR session: " + e);
        return;
      }
      document.getElementById('ar-btn').style.display = 'none';

      const canvas = document.createElement('canvas');
      document.body.appendChild(canvas);
      const gl = canvas.getContext('webgl', { xrCompatible: true });
      renderer = new THREE.WebGLRenderer({ canvas: canvas, context: gl, alpha: true });
      renderer.autoClear = false;
      renderer.setSize(window.innerWidth, window.innerHeight);

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera();
      camera.matrixAutoUpdate = false;

      // Create a colored cube
      const materials = [
        new THREE.MeshBasicMaterial({ color: 0xff0000 }), // right
        new THREE.MeshBasicMaterial({ color: 0x00ff00 }), // left
        new THREE.MeshBasicMaterial({ color: 0x0000ff }), // top
        new THREE.MeshBasicMaterial({ color: 0xffff00 }), // bottom
        new THREE.MeshBasicMaterial({ color: 0xff00ff }), // front
        new THREE.MeshBasicMaterial({ color: 0x00ffff })  // back
      ];
      cube = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 0.2, 0.2),
        materials
      );
      cube.position.set(0, 0, -1); // 1 meter in front of you
      scene.add(cube);

      xrSession.updateRenderState({ baseLayer: new XRWebGLLayer(xrSession, gl) });
      refSpace = await xrSession.requestReferenceSpace('local');

      xrSession.requestAnimationFrame(onXRFrame);
    }

    function onXRFrame(time, frame) {
      xrSession.requestAnimationFrame(onXRFrame);
      const session = frame.session;
      const glLayer = session.renderState.baseLayer;
      const pose = frame.getViewerPose(refSpace);
      if (!pose) return;

      gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);
      renderer.setSize(glLayer.framebufferWidth, glLayer.framebufferHeight, false);

      for (const view of pose.views) {
        const viewport = glLayer.getViewport(view);
        renderer.setViewport(viewport.x, viewport.y, viewport.width, viewport.height);
        camera.matrix.fromArray(view.transform.matrix);
        camera.projectionMatrix.fromArray(view.projectionMatrix);
        camera.updateMatrixWorld(true);
        renderer.render(scene, camera);
      }
    }
  </script>
</body>
</html>
