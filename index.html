<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>VR Tetris (A-Frame + Canvas Embedded)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- A-Frame & Extras -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
  <style>
    body { margin: 0; background: #222; }
    #gameCanvas { display: none; } /* hide, shown in VR only */
  </style>
</head>
<body>
<a-scene background="color: #ECECEC">
  <a-assets>
    <canvas id="gameCanvas" width="240" height="280"></canvas>
  </a-assets>

  <!-- VR floating Tetris screen -->
  <a-plane id="gameScreen"
    class="clickable"
    position="0 1.5 -2.8"
    width="1.2"
    height="1.4"
    material="shader: flat; src: #gameCanvas"
    canvas-texture>
  </a-plane>

  <!-- VR camera rig w/ Quest controllers -->
  <a-entity id="cameraRig" position="0 1.6 0" movement-controls>
    <a-entity camera look-controls wasd-controls position="0 0 0"></a-entity>
    <a-entity id="leftHand" meta-touch-controls="hand: left" laser-controls="hand: left"
      raycaster="objects: .clickable; far: 10"
      line="color: blue; opacity: 0.9"></a-entity>
    <a-entity id="rightHand" meta-touch-controls="hand: right" laser-controls="hand: right"
      raycaster="objects: .clickable; far: 10"
      line="color: red; opacity: 0.9"
      embedded-game-interactive></a-entity>
  </a-entity>
  <a-sky color="#B3E0FF"></a-sky>
  <a-plane color="#7BC8A4" rotation="-90 0 0" width="20" height="20"></a-plane>
  <a-entity light="type: ambient; color: #FFF; intensity: 0.8"></a-entity>
  <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="1 3 2"></a-entity>
</a-scene>

<script>
/**
 * -- VR Embedded Game: Canvas as Live Texture --
 * Core logic from feature PRP and A-Frame docs:
 * https://aframe.io/docs/1.7.0/components/material.html
 * https://aframe.io/docs/1.7.0/components/raycaster.html
 * https://github.com/richardanaya/aframe-html
 */

// Keep the Tetris game hidden on page, shown only as VR texture
// Canvas is loaded via <a-assets> and referenced by #gameScreen

// Canvas texture refresher
AFRAME.registerComponent('canvas-texture', {
  init: function() {
    const canvas = document.getElementById('gameCanvas');
    this.texture = new THREE.CanvasTexture(canvas);
    const mesh = this.el.getObject3D('mesh');
    mesh.material.map = this.texture;
    mesh.material.needsUpdate = true;
    mesh.material.flatShading = true;
  },
  tick: function() {
    if (this.texture) this.texture.needsUpdate = true;
  }
});

// Controller-to-canvas input bridge (trigger = click)
AFRAME.registerComponent('embedded-game-interactive', {
  init: function () {
    this.gameEl = document.querySelector('#gameScreen');
    this.canvasEl = document.getElementById('gameCanvas');
    this.triggerDown = false;
    this.el.addEventListener('triggerdown', this.onTriggerDown.bind(this));
    this.el.addEventListener('triggerup', this.onTriggerUp.bind(this));
  },
  getIntersectionPixel: function () {
    const intersection = this.el.components.raycaster.getIntersection(this.gameEl);
    if (!intersection) return null;
    const uv = intersection.uv;
    // Map to canvas coordinates
    return {
      x: uv.x * this.canvasEl.width,
      y: (1 - uv.y) * this.canvasEl.height
    };
  },
  onTriggerDown: function () {
    const pt = this.getIntersectionPixel();
    if (!pt) return;
    const opts = {clientX: pt.x, clientY: pt.y, button: 0};
    this.canvasEl.dispatchEvent(new MouseEvent('mousemove', opts));
    this.canvasEl.dispatchEvent(new MouseEvent('mousedown', opts));
    this.triggerDown = true;
  },
  onTriggerUp: function () {
    if (!this.triggerDown) return;
    const pt = this.getIntersectionPixel();
    if (!pt) return;
    const opts = {clientX: pt.x, clientY: pt.y, button: 0};
    this.canvasEl.dispatchEvent(new MouseEvent('mouseup', opts));
    this.canvasEl.dispatchEvent(new MouseEvent('click', opts));
    this.triggerDown = false;
  }
});

// -- Tetris Game Code --
// This is your tetris.html logic, but we’ll drop the DOM controls/extra UI so it’s VR-only.
// The game renders to the same #gameCanvas, fully playable by “clicking” with VR controllers.

// (Code is trimmed for brevity here; insert your original <script> code from tetris.html
// but REMOVE/COMMENT all DOM control buttons (dpad, A/B, start), since only canvas clicks matter.)
// For full fidelity, paste your entire game logic from your tetris.html, just keep the canvas rendering part.

// ==== PASTE TETRIS GAME CODE HERE ====

// (For this assistant answer, code omitted for length. In your working file, paste everything
// inside <script> from your original tetris.html, starting at:  // Game constants ...  )

// ======================================

</script>
<!--
Docs/citations:
- Canvas texture: https://aframe.io/docs/1.7.0/components/material.html
- Canvas interaction: https://aframe.io/docs/1.7.0/components/raycaster.html
- VR controller: https://aframe.io/docs/1.7.0/components/meta-touch-controls.html
-->
</body>
</html>
