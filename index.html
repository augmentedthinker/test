<!DOCTYPE html>
<html>
  <head>
    <title>My Magic AR Window with a Circling Ball and Controllers</title>
    <style>
      body { margin: 0; overflow: hidden; }
      canvas { display: block; }
      #arButton {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        padding: 75px 150px;
        font-size: 90px;
        background-color: #000080; /* Dark blue */
        color: white;
        border: 10px solid #000050;
        border-radius: 25px;
        font-weight: bold;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
        box-shadow: 0 0 60px rgba(0, 0, 128, 0.8);
        cursor: pointer;
        z-index: 1000;
        transition: all 0.2s ease-in-out;
      }
      #arButton:hover {
        background-color: #FF0000; /* Fiery red on hover */
        box-shadow: 0 0 90px rgba(255, 0, 0, 0.9);
        transform: translateX(-50%) scale(1.03);
      }
      #arButton:active {
        background-color: #CC0000; /* Darker red when pressed */
        transform: translateX(-50%) scale(0.98);
        box-shadow: 0 0 50px rgba(255, 0, 0, 0.9);
      }
    </style>
  </head>
  <body>
    <script type="module">
      import * as THREE from 'https://unpkg.com/three@0.155.0/build/three.module.js';
      import { ARButton } from 'https://unpkg.com/three@0.155.0/examples/jsm/webxr/ARButton.js';
      // *** NEW HELPER FOR CONTROLLERS! ***
      // This special helper knows how to find and draw the exact models of your Quest controllers.
      import { XRControllerModelFactory } from 'https://unpkg.com/three@0.155.0/examples/jsm/webxr/XRControllerModelFactory.js';

      let camera, scene, renderer, sphere;
      let pivotGroup;
      
      // *** NEW VARIABLES FOR CONTROLLERS ***
      // These will hold our controller objects later.
      let controller1, controller2;
      let controllerGrip1, controllerGrip2; // These are like invisible hands that hold the controller models
      let controllerModelFactory; // Our tool to make the controller models

      init();

      function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        const arButton = ARButton.createButton(renderer, { requiredFeatures: ['local-floor', 'hit-test'] });
        arButton.id = 'arButton';
        document.body.appendChild(arButton);

        // Add lights so we can see our sphere
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(0, 5, 5);
        scene.add(directionalLight);

        // Setup the orbiting sphere
        pivotGroup = new THREE.Group();
        scene.add(pivotGroup);
        const geometry = new THREE.SphereGeometry(0.5, 32, 32);
        const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
        sphere = new THREE.Mesh(geometry, material);
        sphere.position.set(0, 1.2, -2);
        pivotGroup.add(sphere);

        // --- NEW MAGIC FOR OUR CONTROLLERS! ---

        // 1. Get our special tool ready to make controller models.
        controllerModelFactory = new XRControllerModelFactory();

        // 2. Set up Controller 1 (usually your right hand)
        controller1 = renderer.xr.getController(0); // This gets the controller's "pointer"
        scene.add(controller1); // Add it to the scene so it can track movement

        controllerGrip1 = renderer.xr.getControllerGrip(0); // This gets the "grip" part, where the model will sit
        // Load the actual 3D model of the Quest controller and add it to the grip.
        controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1));
        scene.add(controllerGrip1); // Add the grip (with its model) to the scene

        // 3. Set up Controller 2 (usually your left hand) - same steps!
        controller2 = renderer.xr.getController(1);
        scene.add(controller2);

        controllerGrip2 = renderer.xr.getControllerGrip(1);
        controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2));
        scene.add(controllerGrip2);

        // Optional: Add a simple ray (like a laser pointer) coming out of each controller
        // This helps you see where you're "pointing" with your controllers.
        const rayGeometry = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, -1)]);
        const rayMaterial = new THREE.LineBasicMaterial({ color: 0xff00ff, linewidth: 2 }); // Magenta colored line

        const line1 = new THREE.Line(rayGeometry, rayMaterial);
        line1.scale.z = 5; // Make the line 5 units long (5 meters)
        controller1.add(line1); // Attach it to the "pointer" part of Controller 1

        const line2 = new THREE.Line(rayGeometry, rayMaterial);
        line2.scale.z = 5;
        controller2.add(line2); // Attach it to the "pointer" part of Controller 2

        // Set the animation loop to keep everything moving.
        renderer.setAnimationLoop(render);

        window.addEventListener('resize', onWindowResize);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function render() {
        pivotGroup.rotation.y += 0.005; // Keep the ball circling!

        renderer.render(scene, camera); // Draw everything!
      }
    </script>
  </body>
</html>
