<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Animaeus • Intro (VR minimal, A-Frame)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.3.4/dist/aframe-environment-component.min.js"></script>
  <style>
    body { margin:0; background:#071018; }
    .hint {
      position: fixed; left: 10px; bottom: 10px; padding:8px 10px;
      color:#9fc7dd; background:#08131d; border:1px solid #0e2232; border-radius:10px;
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; opacity:.8;
    }
  </style>
</head>
<body>
<div class="hint">Point at the green “BEGIN” card and pull trigger. VR button appears at bottom-right.</div>

<a-scene renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true"
         xr-mode-ui="enabled: true" background="color: #0a141e">

  <!-- environment (re-using your env style) -->
  <a-entity id="env" environment="preset: forest; groundColor: #0c2231; fog: 0.4;"></a-entity>

  <!-- lights -->
  <a-entity light="type: hemisphere; intensity: 0.8; color: #bfe8ff; groundColor: #0a2030"></a-entity>
  <a-entity light="type: directional; intensity: 1.1" position="1.5 3 2"></a-entity>

  <!-- rig + controllers (re-using your models/lasers/raycasters) -->
  <a-entity id="rig" position="0 1.6 0">
    <a-entity id="cam" camera look-controls></a-entity>

    <a-entity id="leftHand"
              oculus-touch-controls="hand: left; model: true"
              laser-controls="hand: left"
              raycaster="objects: .clickable; far: 30"
              line="color: #6ee7ff; opacity: 0.9"></a-entity>

    <a-entity id="rightHand"
              oculus-touch-controls="hand: right; model: true"
              laser-controls="hand: right"
              raycaster="objects: .clickable; far: 30"
              line="color: #6ee7ff; opacity: 0.9"></a-entity>
  </a-entity>

  <!-- START CARD -->
  <a-entity id="startCard" class="clickable"
            position="0 1.4 -2" geometry="primitive: plane; width: 1.2; height: 0.35"
            material="color: #1b7a4b; opacity: 0.95; side: double" card-hover>
    <a-text value="BEGIN" color="#ffffff" width="2.5" align="center" position="0 0 0.01"></a-text>
  </a-entity>

  <!-- LOG LINE (last spoken line) -->
  <a-text id="log" value="—" color="#d6e6f5" width="3.5" align="center" position="0 1.0 -2"></a-text>

  <!-- ANIMAEUS ORB (hidden until start) -->
  <a-entity id="animaeus" visible="false" position="0 1.65 -1.2" animaeus-avatar animaeus-talker></a-entity>

</a-scene>

<script>
// ——— unlock audio on first interaction (same idea you used) ———
let audioUnlocked = false;
function unlockAudio(){ audioUnlocked = true; }
window.addEventListener('click', unlockAudio, {once:true});
window.addEventListener('touchstart', unlockAudio, {once:true});

// ——— hover feedback for clickable planes ———
AFRAME.registerComponent('card-hover',{
  init(){
    const el = this.el;
    const base = el.getAttribute('material');
    el.addEventListener('mouseenter', ()=> el.setAttribute('material', {...base, color:'#1f8e58'}));
    el.addEventListener('mouseleave', ()=> el.setAttribute('material', {...base, color:'#1b7a4b'}));
  }
});

// ——— simple Animaeus avatar (orb + eyes + mouth pulse) ———
AFRAME.registerComponent('animaeus-avatar',{
  init(){
    const el = this.el;

    const orb = document.createElement('a-sphere');
    orb.setAttribute('radius','0.22');
    orb.setAttribute('material','color:#0c1a26; metalness:0.3; roughness:0.4; emissive:#0d2a3d; emissiveIntensity:0.25');
    el.appendChild(orb);

    const halo = document.createElement('a-ring');
    halo.setAttribute('rotation','-90 0 0');
    halo.setAttribute('radius-inner','0.26');
    halo.setAttribute('radius-outer','0.40');
    halo.setAttribute('material','color:#6ee7ff; opacity:0.16; side:double');
    el.appendChild(halo);

    const eyeL = document.createElement('a-circle');
    eyeL.setAttribute('radius','0.022'); eyeL.setAttribute('color','#9ad8ff'); eyeL.setAttribute('position','-0.07 0.05 0.19');
    const eyeR = document.createElement('a-circle');
    eyeR.setAttribute('radius','0.022'); eyeR.setAttribute('color','#9ad8ff'); eyeR.setAttribute('position','0.07 0.05 0.19');
    el.appendChild(eyeL); el.appendChild(eyeR);

    const mouth = document.createElement('a-plane');
    mouth.setAttribute('width','0.14'); mouth.setAttribute('height','0.02'); mouth.setAttribute('color','#9ad8ff');
    mouth.setAttribute('position','0 -0.02 0.2'); mouth.setAttribute('material','transparent:true; opacity:0.95');
    el.appendChild(mouth);
    this.mouth = mouth;

    this.eyes = [eyeL, eyeR];
    this.t = 0; this.blinkClock = 0; this.blinking=false;
  },
  tick(t,dt){
    this.t += dt/1000;
    const bob = Math.sin(this.t*1.3)*0.02;
    this.el.object3D.position.y = 1.65 + bob;

    // gentle look-at camera
    const cam = document.getElementById('cam').object3D;
    this.el.object3D.lookAt(cam.position);

    // random blink
    this.blinkClock += dt;
    if(!this.blinking && this.blinkClock > 1200 + Math.random()*2200){
      this.blinking = true; this.blinkClock = 0;
      this.eyes.forEach(e=> e.setAttribute('scale','1 0.1 1'));
      setTimeout(()=>{ this.eyes.forEach(e=> e.setAttribute('scale','1 1 1')); this.blinking=false; }, 110);
    }
  }
});

// ——— talker: text-to-speech + mouth pulse ———
AFRAME.registerComponent('animaeus-talker',{
  init(){
    this.synth = window.speechSynthesis || null;
    this.speaking = false;
    this.avatar = this.el.components['animaeus-avatar'];

    const loop = ()=>{
      if(this.speaking && this.avatar?.mouth){
        const s = 0.8 + Math.random()*0.7;
        this.avatar.mouth.object3D.scale.set(1, s, 1);
      } else if (this.avatar?.mouth){
        this.avatar.mouth.object3D.scale.set(1, 1, 1);
      }
      requestAnimationFrame(loop);
    };
    loop();

    this.el.addEventListener('speak',(e)=> this.say(e.detail||'...'));
    this.el.addEventListener('stopvoice',()=> this.stop());
  },
  say(text){
    // show last line
    const log = document.getElementById('log');
    log.setAttribute('value', text);

    if(!this.synth) return;
    try{
      this.synth.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.02; u.pitch = 1.0;
      u.onstart = ()=> this.speaking = true;
      u.onend   = ()=> this.speaking = false;
      // try to start after first user gesture (mobile/Quest audio policy)
      if(audioUnlocked) this.synth.speak(u); else setTimeout(()=>this.synth.speak(u), 50);
    }catch(e){}
  },
  stop(){ try{ this.synth?.cancel(); }catch(e){} this.speaking=false; }
});

// ——— start flow ———
const intro =
  "You wake to a hush: circuits dim, air cool. “Welcome back,” I say. I’m Animaeus. We start with a question: do you want the world as it is, or the one that’s trying to be born?";

document.getElementById('startCard').addEventListener('click', ()=>{
  const orb = document.getElementById('animaeus');
  orb.setAttribute('visible', true);
  orb.emit('speak', intro);
  // hide start card once used
  document.getElementById('startCard').setAttribute('visible', false);
});
</script>
</body>
</html>
