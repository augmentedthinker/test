<!DOCTYPE html>
<html>
  <head>
    <title>VR Room with Controller Interaction</title>
    <!-- A-Frame library from CDN -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- A-Frame Extras for animation-mixer (if needed for models) and other utilities -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <style>
      /* Basic styling for the body to ensure it takes full viewport */
      body { margin: 0; overflow: hidden; }
      /* Ensure the A-Frame canvas fills the screen */
      .a-canvas {
        width: 100vw !important;
        height: 100vh !important;
      }
    </style>
  </head>
  <body>
    <!-- The A-Frame scene is the root of your VR experience -->
    <a-scene background="color: #FAFAFA">
      <!--
        Assets section: Preload all your images, models, audio, and video here.
        Preloading improves performance by ensuring assets are ready before they are needed.
        The timeout attribute (default 3000ms) waits for assets to load before scene starts.
      -->
      <a-assets timeout="5000">
        <!-- Define a mixin for reusable material properties -->
        <a-mixin id="interactive-material" material="color: #4CC3D9; roughness: 0.8; metalness: 0.1;"></a-mixin>
        <a-mixin id="hover-material" material="color: #FFC65D; roughness: 0.8; metalness: 0.1;"></a-mixin>
        <a-mixin id="clicked-material" material="color: #EF2D5E; roughness: 0.8; metalness: 0.1;"></a-mixin>
      </a-assets>

      <!--
        Camera and Player Setup:
        The a-camera entity represents the user's viewpoint.
        position="0 1.6 0" places the camera at a typical eye height (1.6 meters).
        The a-cursor is for gaze-based interaction (looking at objects).
      -->
      <a-camera position="0 1.6 0">
        <a-cursor fuse="true" fuse-timeout="1500" color="#FFFFFF" opacity="0.5"></a-cursor>
      </a-camera>

      <!--
        Controller Setup:
        meta-touch-controls automatically handles Quest 2 controller tracking and model rendering.
        It also emits events for button presses (e.g., 'triggerdown', 'gripdown').
        We attach a custom component 'controller-logger' to log controller events.
        We also attach 'raycaster' for laser-pointer interaction and 'line' to visualize the ray.
      -->
      <a-entity id="leftHand" meta-touch-controls="hand: left" controller-logger raycaster="objects: .interactable; far: 20;" line="color: cyan; opacity: 0.7"></a-entity>
      <a-entity id="rightHand" meta-touch-controls="hand: right" controller-logger raycaster="objects: .interactable; far: 20;" line="color: blue; opacity: 0.7"></a-entity>

      <!--
        Environment:
        A simple sky for a background.
        A plane for the ground.
      -->
      <a-sky color="#87CEEB"></a-sky> <!-- Light blue sky -->
      <a-plane position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane> <!-- Green ground -->

      <!--
        Interactive Elements:
        These objects will change color when hovered over or clicked with the controller/gaze.
        The 'class="interactable"' is crucial for the raycaster to detect these objects.
      -->
      <a-box class="interactable" mixin="interactive-material" position="-2 0.5 -3" rotation="0 45 0"
             event-set__mouseenter="mixin: hover-material"
             event-set__mouseleave="mixin: interactive-material"
             event-set__click="mixin: clicked-material; _target: #clickText; value: Box Clicked!"
             event-set__click-reset="_event: click; _target: #clickText; value: Click an object.; _delay: 1000">
        <a-text value="Click Me!" align="center" position="0 0.6 0" color="#000"></a-text>
      </a-box>

      <a-sphere class="interactable" mixin="interactive-material" position="2 1.25 -5" radius="1.25"
                event-set__mouseenter="mixin: hover-material"
                event-set__mouseleave="mixin: interactive-material"
                event-set__click="mixin: clicked-material; _target: #clickText; value: Sphere Clicked!"
                event-set__click-reset="_event: click; _target: #clickText; value: Click an object.; _delay: 1000">
        <a-text value="Click Me Too!" align="center" position="0 1.3 0" color="#000"></a-text>
      </a-sphere>

      <a-cylinder class="interactable" mixin="interactive-material" position="0 0.75 -2" radius="0.5" height="1.5"
                  event-set__mouseenter="mixin: hover-material"
                  event-set__mouseleave="mixin: interactive-material"
                  event-set__click="mixin: clicked-material; _target: #clickText; value: Cylinder Clicked!"
                  event-set__click-reset="_event: click; _target: #clickText; value: Click an object.; _delay: 1000">
        <a-text value="And Me!" align="center" position="0 0.8 0" color="#000"></a-text>
      </a-cylinder>

      <!-- Text display for click feedback -->
      <a-text id="clickText" value="Click an object." align="center" position="0 3 -4" color="#FFF" width="5"></a-text>

      <!--
        Custom A-Frame Component for Controller Logging:
        This component listens for various controller events and logs them to the console.
        This is useful for debugging and understanding which events fire when.
      -->
      <script>
        AFRAME.registerComponent('controller-logger', {
          init: function () {
            const el = this.el; // The entity this component is attached to (e.g., leftHand or rightHand)
            const hand = el.getAttribute('meta-touch-controls').hand; // Get which hand this controller is for

            console.log(`Controller Logger initialized for ${hand} hand.`);

            // Listen for various controller events and log them
            el.addEventListener('triggerdown', () => {
              console.log(`${hand} triggerdown`);
              // Example: Change color of the object being pointed at
              const intersectedEl = el.components.raycaster.intersectedEls[0];
              if (intersectedEl) {
                intersectedEl.setAttribute('material', 'color', '#FF0000'); // Turn red on trigger
                setTimeout(() => {
                  intersectedEl.setAttribute('material', 'color', '#4CC3D9'); // Revert after a short delay
                }, 200);
              }
            });
            el.addEventListener('triggerup', () => {
              console.log(`${hand} triggerup`);
            });
            el.addEventListener('gripdown', () => {
              console.log(`${hand} gripdown`);
            });
            el.addEventListener('gripup', () => {
              console.log(`${hand} gripup`);
            });
            el.addEventListener('thumbstickdown', () => {
              console.log(`${hand} thumbstickdown`);
            });
            el.addEventListener('thumbstickup', () => {
              console.log(`${hand} thumbstickup`);
            });
            el.addEventListener('thumbstickmoved', (evt) => {
              // console.log(`${hand} thumbstickmoved: x=${evt.detail.x.toFixed(2)}, y=${evt.detail.y.toFixed(2)}`);
            });
            el.addEventListener('abuttondown', () => {
              console.log(`${hand} A button down`);
            });
            el.addEventListener('bbuttondown', () => {
              console.log(`${hand} B button down`);
            });
            el.addEventListener('xbuttondown', () => {
              console.log(`${hand} X button down`);
            });
            el.addEventListener('ybuttondown', () => {
              console.log(`${hand} Y button down`);
            });
          }
        });
      </script>
    </a-scene>
  </body>
</html>
