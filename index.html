<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Quest VR: Player Hit Detection</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
</head>
<body>
<a-scene background="color: #ECECEC">
  <a-assets></a-assets>
  <a-entity id="cameraRig" position="0 1.6 0" movement-controls>
    <a-entity id="playerCam" camera look-controls wasd-controls position="0 0 0"></a-entity>
    <a-entity id="leftHand"
              meta-touch-controls="hand: left; model: true"
              laser-controls="hand: left"
              raycaster="objects: .clickable; far: 100"
              line="color: blue; opacity: 0.9"></a-entity>
    <a-entity id="rightHand"
              meta-touch-controls="hand: right; model: true"
              laser-controls="hand: right"
              raycaster="objects: .clickable; far: 100"
              line="color: red; opacity: 0.9"></a-entity>
    <!-- Player hitbox sphere -->
    <a-sphere id="playerSphere"
              color="#FFFFFF"
              opacity="0.6"
              radius="0.18"
              position="0 1.3 0"
              visible="true"></a-sphere>
  </a-entity>
  <a-sky color="#B3E0FF"></a-sky>
  <a-plane id="ground" color="#7BC8A4" rotation="-90 0 0" width="20" height="20"></a-plane>
  <a-entity light="type: ambient; color: #FFF; intensity: 0.8"></a-entity>
  <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="1 3 2"></a-entity>
  <!-- Main clickable sphere -->
  <a-sphere id="colorSphere"
            class="clickable"
            position="0 2 0"
            radius="0.4"
            color="#FFC300"
            shadow="cast: true"
            toggle-color-on-click
            shoot-on-click
            flash-on-hit></a-sphere>
  <script>
    // Toggle central sphere color
    AFRAME.registerComponent('toggle-color-on-click', {
      schema: {
        colors: {type: 'array', default: ['#FFC300', '#32CD32', '#1976D2', '#E53935']}
      },
      init: function () {
        this.colorIndex = 0;
        this.el.addEventListener('click', () => {
          this.colorIndex = (this.colorIndex + 1) % this.data.colors.length;
          this.el.setAttribute('color', this.data.colors[this.colorIndex]);
        });
      }
    });

    // Flash the central sphere when called
    AFRAME.registerComponent('flash-on-hit', {
      schema: {},
      init: function () {
        this.originalScale = this.el.object3D.scale.clone();
        this.originalColor = this.el.getAttribute('color');
      },
      flash: function () {
        let el = this.el;
        // Flash: grow and change color
        el.setAttribute('color', '#FFF');
        el.object3D.scale.set(1.3, 1.3, 1.3);
        setTimeout(() => {
          el.setAttribute('color', this.originalColor);
          el.object3D.scale.copy(this.originalScale);
        }, 400); // 0.4s flash
      }
    });

    // Shoot projectile at player when main sphere clicked
    AFRAME.registerComponent('shoot-on-click', {
      schema: {
        speed: {type: 'number', default: 1.5}
      },
      init: function () {
        this.el.addEventListener('click', () => {
          var rig = document.querySelector('#cameraRig');
          var rigPos = new THREE.Vector3();
          rig.object3D.getWorldPosition(rigPos);

          // Get position between controllers
          var left = document.querySelector('#leftHand').object3D;
          var right = document.querySelector('#rightHand').object3D;
          var lp = new THREE.Vector3(), rp = new THREE.Vector3();
          left.getWorldPosition(lp); right.getWorldPosition(rp);
          var mid = lp.clone().add(rp).multiplyScalar(0.5);

          // Use midpoint as target
          var origin = new THREE.Vector3();
          this.el.object3D.getWorldPosition(origin);
          var direction = mid.clone().sub(origin).normalize();

          // Create projectile
          var scene = this.el.sceneEl;
          var projectile = document.createElement('a-sphere');
          projectile.setAttribute('radius', 0.12);
          projectile.setAttribute('color', '#E53935');
          projectile.setAttribute('position', `${origin.x} ${origin.y} ${origin.z}`);
          projectile.setAttribute('projectile-move', {
            direction: `${direction.x} ${direction.y} ${direction.z}`,
            speed: this.data.speed
          });
          scene.appendChild(projectile);
        });
      }
    });

    // Move projectile, check collision with player sphere
    AFRAME.registerComponent('projectile-move', {
      schema: {
        direction: {type: 'string', default: '0 0 0'},
        speed: {type: 'number', default: 1.5}
      },
      init: function () {
        var d = this.data.direction.split(' ').map(Number);
        this.directionVec = new THREE.Vector3(d[0], d[1], d[2]);
        this.speed = this.data.speed;
        this.start = null;
        this.hit = false;
      },
      tick: function (time, deltaTime) {
        if (this.hit) return;
        if (!this.start) this.start = time;
        var move = this.directionVec.clone().multiplyScalar(this.speed * deltaTime / 1000);
        this.el.object3D.position.add(move);

        // Collision with player sphere
        var player = document.querySelector('#playerSphere');
        if (player) {
          var projectilePos = this.el.object3D.position;
          var playerPos = player.object3D.getWorldPosition(new THREE.Vector3());
          var dist = projectilePos.distanceTo(playerPos);
          var combinedRadius = 0.12 + 0.18; // projectile + player sphere radii
          if (dist < combinedRadius) {
            this.hit = true;
            // Flash central sphere
            var colorSphere = document.querySelector('#colorSphere');
            if (colorSphere && colorSphere.components['flash-on-hit']) {
              colorSphere.components['flash-on-hit'].flash();
            }
            // Remove projectile
            this.el.parentNode.removeChild(this.el);
            return;
          }
        }
        // Auto-remove after 8s
        if (time - this.start > 8000) this.el.parentNode.removeChild(this.el);
      }
    });

    // Update player sphere position to midpoint between hands
    AFRAME.registerComponent('player-follow-hands', {
      tick: function () {
        var left = document.querySelector('#leftHand').object3D;
        var right = document.querySelector('#rightHand').object3D;
        var playerSphere = document.querySelector('#playerSphere');
        if (left && right && playerSphere) {
          var lp = new THREE.Vector3(), rp = new THREE.Vector3();
          left.getWorldPosition(lp);
          right.getWorldPosition(rp);
          var mid = lp.add(rp).multiplyScalar(0.5);
          playerSphere.object3D.position.copy(mid);
        }
      }
    });

    // Attach player-follow-hands to the cameraRig
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelector('#cameraRig').setAttribute('player-follow-hands', '');
    });
  </script>
</a-scene>
</body>
</html>
