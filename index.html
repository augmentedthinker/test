<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VR Polar Bars Audio Visualizer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#000; color:#9ff; }
    .ui { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; display:flex; gap:10px; z-index:5; }
    button { border:2px solid #00FFFF88; background:#001a1a; color:#9ff; padding:10px 14px; border-radius:999px; cursor:pointer; font-size:14px; }
    button:hover { background:#003333; }
    .status { position:fixed; left:20px; top:16px; z-index:5; opacity:.9; font-size:14px; color:#8ff; }
    .warn { color:#ff9; }
    .err { color:#f88; }
  </style>
</head>
<body>
  <div class="status" id="status">üîä Ready. Click <b>Start Mic</b> (Quest needs HTTPS on GitHub Pages).</div>
  <div class="ui">
    <button id="startBtn">üé§ Start Mic</button>
    <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
    <button id="recenterBtn">üéØ Recenter</button>
  </div>

  <!-- SCENE -->
  <a-scene renderer="antialias: true; colorManagement: true" background="color: #000">
    <!-- Camera + controllers -->
    <a-entity id="cameraRig" position="0 1.6 0">
      <a-entity id="camera" camera look-controls></a-entity>
      <a-entity oculus-touch-controls="hand: left; model: true" laser-controls="hand: left" raycaster="objects: .clickable; far: 30" line="color: #6ee7ff; opacity: 0.9"></a-entity>
      <a-entity oculus-touch-controls="hand: right; model: true" laser-controls="hand: right" raycaster="objects: .clickable; far: 30" line="color: #6ee7ff; opacity: 0.9"></a-entity>
    </a-entity>

    <!-- Cosmic shell so you're inside a sphere -->
    <a-entity id="shell"
              geometry="primitive: sphere; radius: 8; segmentsWidth: 96; segmentsHeight: 64"
              material="color: #02141a; metalness: 0.0; roughness: 1.0; side: back; emissive:#012; emissiveIntensity:0.3"
              position="0 1.6 0"></a-entity>

    <!-- South pole glow disk (lit up pole) -->
    <a-entity id="southGlow" position="0 -6.4 0"> <!-- -radius*0.8 relative to rig -->
      <a-circle radius="1.6" rotation="-90 0 0" material="color:#0ff; emissive:#0ff; emissiveIntensity:1.2; opacity:0.85; transparent:true"></a-circle>
      <a-ring radius-inner="1.7" radius-outer="2.4" rotation="-90 0 0" material="color:#6cf; emissive:#6cf; emissiveIntensity:0.8; opacity:0.5; transparent:true"></a-ring>
    </a-entity>

    <!-- Bars group (erupts from south pole upward) -->
    <a-entity id="bars" polar-visualizer="radius: 8; bands: 48"></a-entity>
  </a-scene>

  <script>
    // ===== Polar Bars Visualizer Component =====
    AFRAME.registerComponent('polar-visualizer', {
      schema: { radius: {type:'number', default: 8}, bands: {type:'int', default: 48} },
      init(){
        this.started=false; this.audioCtx=null; this.analyser=null; this.src=null; this.data=null;
        this.bars=[]; this.levels=[]; this.target=[]; this.time=0;
        this._makeBars();
        this._bindUI();
      },
      _bindUI(){
        const status = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const recenterBtn = document.getElementById('recenterBtn');

        startBtn.addEventListener('click', async () => {
          try {
            if (this.started) return;
            const stream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true, noiseSuppression:true}});
            this.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            this.analyser = this.audioCtx.createAnalyser();
            this.analyser.fftSize = 1024; // more bands ‚Üí smoother circle mapping
            this.analyser.smoothingTimeConstant = 0.7;
            this.src = this.audioCtx.createMediaStreamSource(stream);
            this.src.connect(this.analyser);
            this.data = new Uint8Array(this.analyser.frequencyBinCount);
            this.started=true; startBtn.disabled=true; stopBtn.disabled=false;
            status.textContent = 'üéß Listening‚Ä¶ bars rise from the south pole.';
          } catch(e){
            status.innerHTML = '‚ùå <span class="err">Microphone permission failed.</span> Use HTTPS in Quest and allow mic.';
            console.error(e);
          }
        });

        stopBtn.addEventListener('click', () => {
          if (!this.started) return;
          if (this.audioCtx) this.audioCtx.close();
          this.audioCtx=null; this.analyser=null; this.src=null; this.data=null; this.started=false;
          startBtn.disabled=false; stopBtn.disabled=true; status.textContent='‚èπÔ∏è Stopped.';
        });

        recenterBtn.addEventListener('click', () => {
          const rig = document.getElementById('cameraRig');
          rig.setAttribute('position', '0 1.6 0');
          status.textContent = 'üéØ Recentered.';
        });
      },
      _makeBars(){
        const R = this.dataRadius = this.dataRadius || this.dataRadius; // no-op, keeps closure tidy
        const radius = this.dataRadius = this.dataRadius || this.dataRadius;
        const el = this.el; const N = this.dataBands = this.dataBands || this.dataBands;
      },
      update(){
        // build bars on update (first run)
        const radius = this.data.radius;
        const bands = this.data.bands;
        const ring = 1.2; // small base circle around south pole
        const baseY = -radius + 0.1; // just above the south pole
        const group = this.el;
        // clear if any
        while (group.firstChild) group.removeChild(group.firstChild);
        this.bars=[]; this.levels=[]; this.target=[];
        for (let i=0;i<bands;i++){
          const phi = (i/bands) * Math.PI*2; // around Y axis
          const x = Math.cos(phi)*ring;
          const z = Math.sin(phi)*ring;
          const y = baseY;
          const bar = document.createElement('a-cylinder');
          bar.setAttribute('position', `${x} ${y} ${z}`);
          bar.setAttribute('radius', 0.06);
          bar.setAttribute('height', 0.2); // minimal at rest
          bar.setAttribute('material', 'color:#0ff; emissive:#08f; emissiveIntensity:0.5; metalness:0.2; roughness:0.6; opacity:0.95; transparent:true');
          // tilt bars very slightly toward the pole for aesthetics
          const tilt = -4; // degrees
          bar.setAttribute('rotation', `${tilt} ${(phi*180/Math.PI)} 0`);
          group.appendChild(bar);
          this.bars.push(bar);
          this.levels.push(0.2);
          this.target.push(0.2);
        }
        // glow stronger near the south pole
        const glow = document.getElementById('southGlow');
        if (glow) glow.setAttribute('animation__pulse', 'property=rotation; to=-90 360 0; loop=true; dur=12000; easing=linear');
      },
      _band(i){
        // map bars around the ring to analyser bins (wrap/average groups)
        if (!this.data) return 0;
        const bins = this.data.length; // e.g., 512
        const bands = this.data.bands || this.data.bands; // not accessible here; use this.data instead
        return 0;
      },
      tick(t, dt){
        if (!this.bars || this.bars.length===0) return;
        if (this.started && this.analyser && this.data){
          this.analyser.getByteFrequencyData(this.data);
        }
        // map spectrum ‚Üí bars
        const bins = this.data ? this.data.length : 0;
        const N = this.bars.length;
        for(let i=0;i<N;i++){
          let v=0;
          if (bins){
            // average a small cluster of bins per bar, bias to lows near index 0
            const start = Math.floor( Math.pow(i/N, 1.2) * (bins-1) );
            const spread = Math.max(1, Math.floor(bins / (N*3)));
            let s=0,c=0;
            for (let k=0;k<spread;k++){
              const idx = Math.min(bins-1, start+k);
              s += this.data[idx]; c++;
            }
            v = c? (s/c)/255 : 0;
          }
          const minH = 0.2;
          const maxH = 16.2; // can rise well past equator (y=0) toward north pole
          const targetH = minH + v * (maxH - minH);
          // ease height for smoothness
          this.target[i] = targetH;
          this.levels[i] = this.levels[i] * 0.78 + this.target[i] * 0.22;
          const bar = this.bars[i];
          bar.setAttribute('height', this.levels[i]);
          // move so the base hugs the south side and grows upward along +Y
          const pos = bar.getAttribute('position');
          bar.setAttribute('position', `${pos.x} ${(-8 + this.levels[i]/2)} ${pos.z}`);
          // color shift per bar based on its level
          const hue = 200/360 - Math.min(0.25, v*0.25); // cyan‚Üíblue
          const hsl = `hsl(${hue*360}, 90%, ${45 + Math.min(25, v*40)}%)`;
          bar.setAttribute('material', `color:${hsl}; emissive:${hsl}; emissiveIntensity:${0.5 + v*1.0}; opacity:0.95; metalness:0.2; roughness:0.6`);
        }
      }
    });
  </script>
</body>
</html>
