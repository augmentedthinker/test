<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oculus Quest 2 AR Passthrough</title>
    <!-- Tailwind CSS for basic styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the body and canvas */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Hide scrollbars */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        #ar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Canvas behind button */
        }
        #ar-button {
            z-index: 1; /* Button on top */
            padding: 1rem 2rem;
            font-size: 1.25rem;
            cursor: pointer;
            border: none;
            border-radius: 0.75rem; /* Rounded corners */
            background-color: #4299e1; /* Blue background */
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        #ar-button:hover {
            background-color: #3182ce; /* Darker blue on hover */
            transform: translateY(-2px);
        }
        #ar-button:active {
            transform: translateY(0);
        }
        #message-box {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            z-index: 10;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div id="ar-container">
        <button id="ar-button" class="rounded-xl shadow-lg">Enter AR</button>
        <div id="message-box"></div>
    </div>

    <!-- Three.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script type="module">
        // Global variables for Three.js scene
        let scene, camera, renderer;
        let cube; // The 3D object to display
        let arButton = document.getElementById('ar-button');
        let messageBox = document.getElementById('message-box');

        /**
         * Displays a temporary message to the user.
         * @param {string} message - The message to display.
         * @param {number} duration - How long to display the message in milliseconds.
         */
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        /**
         * Initializes the Three.js scene, camera, and renderer.
         */
        function init() {
            // Create a new Three.js scene
            scene = new THREE.Scene();

            // Create a perspective camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5; // Set initial camera position

            // Create a WebGL renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); // alpha: true for transparent background in AR
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true; // Enable WebXR on the renderer
            document.getElementById('ar-container').appendChild(renderer.domElement);

            // Create a simple cube geometry
            const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5); // Size of the cube
            // Create a material for the cube (e.g., a basic mesh material)
            const material = new THREE.MeshNormalMaterial(); // Shows normal vectors as colors
            // Create the cube mesh
            cube = new THREE.Mesh(geometry, material);
            cube.position.set(0, 0, -1); // Position the cube in front of the camera in AR space
            scene.add(cube); // Add the cube to the scene

            // Add a light to the scene
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); // Soft white light
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);

            // Handle window resizing
            window.addEventListener('resize', onWindowResize, false);
        }

        /**
         * Resizes the renderer and camera when the window is resized.
         */
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        /**
         * The animation loop for rendering the scene.
         * This function is called repeatedly by the WebXR manager.
         * @param {number} time - The current time.
         * @param {XRFrame} frame - The current XR frame.
         */
        function animate() {
            // Set the animation loop to be controlled by the WebXR renderer
            renderer.setAnimationLoop(render);
        }

        /**
         * Renders the Three.js scene.
         */
        function render() {
            // Rotate the cube for visual effect
            cube.rotation.x += 0.01;
            cube.rotation.y += 0.01;

            // Render the scene with the camera
            renderer.render(scene, camera);
        }

        /**
         * Checks for WebXR AR session support and updates the button.
         */
        async function checkARSupport() {
            if (navigator.xr) {
                try {
                    // Check if 'immersive-ar' session is supported
                    const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
                    if (isSupported) {
                        arButton.textContent = 'Enter AR';
                        arButton.addEventListener('click', onARButtonClick);
                        showMessage('WebXR AR supported. Click "Enter AR" to begin.', 5000);
                    } else {
                        arButton.textContent = 'AR Not Supported';
                        arButton.disabled = true;
                        showMessage('WebXR AR not supported on this device/browser.', 5000);
                    }
                } catch (error) {
                    console.error('Error checking WebXR support:', error);
                    arButton.textContent = 'AR Error';
                    arButton.disabled = true;
                    showMessage('Error checking WebXR support. See console for details.', 5000);
                }
            } else {
                arButton.textContent = 'WebXR Not Found';
                arButton.disabled = true;
                showMessage('WebXR API not found. Please use a WebXR-compatible browser (e.g., Oculus Browser).', 5000);
            }
        }

        /**
         * Handles the "Enter AR" button click event.
         * Requests an 'immersive-ar' WebXR session.
         */
        async function onARButtonClick() {
            if (!navigator.xr) {
                showMessage('WebXR API not available.', 3000);
                return;
            }

            try {
                // Request an 'immersive-ar' session
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local', 'hit-test'], // 'local' for basic AR, 'hit-test' for placing objects
                    optionalFeatures: ['dom-overlay'], // Optional for UI elements
                });

                // Set the renderer's XR session
                renderer.xr.setSession(session);

                // Hide the button once AR session starts
                arButton.style.display = 'none';
                showMessage('Entering AR experience...', 3000);

                // Start the animation loop for AR
                animate();

                // Listen for session end
                session.addEventListener('end', () => {
                    console.log('AR Session Ended');
                    arButton.style.display = 'block'; // Show button again
                    showMessage('AR session ended.', 3000);
                });

            } catch (error) {
                console.error('Failed to start AR session:', error);
                showMessage(`Failed to start AR session: ${error.message}`, 5000);
                arButton.style.display = 'block'; // Ensure button is visible if session fails to start
            }
        }

        // Initialize Three.js when the window loads
        window.onload = function() {
            init();
            checkARSupport();
        };

    </script>
</body>
</html>
