<!DOCTYPE html>
<html>
  <head>
    <title>Immersive A-Frame VR Environment for Meta Quest 2/3</title>
    <script src="https://unpkg.com/aframe@1.5.0/dist/aframe-master.min.js"></script>

    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    <script src="https://unpkg.com/aframe-particle-system-component@1.1.0/dist/aframe-particle-system-component.min.js"></script>
    <script src="https://unpkg.com/aframe-aabb-collider-component@3.1.0/dist/aframe-aabb-collider-component.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <a-scene
      renderer="colorManagement: true; dracoDecoderPath: https://www.gstatic.com/draco/v1/decoders/; basisTranscoderPath: https://unpkg.com/aframe@1.5.0/dist/basis/"
      fog="type: exponential; color: #DDEEFF; density: 0.001"
    >
      <a-assets>
        <audio
          id="forestSound"
          src="https://cdn.aframe.io/examples/component-sound/assets/audio/forest.ogg"
          preload="auto"
        ></audio>
        <audio
          id="rainSound"
          src="https://cdn.aframe.io/examples/boilerplate/assets/audio/rain.ogg"
          preload="auto"
        ></audio>
        <audio
          id="snowSound"
          src="https://cdn.aframe.io/examples/boilerplate/assets/audio/snow.ogg"
          preload="auto"
        ></audio>
      </a-assets>

      <a-entity
        id="playerRig"
        movement-controls="speed: 0.15;"
        position="0 1.6 0"
        aabb-collider="objects: .regionTrigger; interval: 100"
      >
        <a-camera look-controls="pointerLockEnabled: false"></a-camera>
        <a-entity
          id="rightHand"
          hand-controls="hand: right"
          laser-controls="hand: right"
          raycaster="objects: [raycaster-target]; far: 10; showLine: true; lineColor: red; lineOpacity: 0.5;"
        ></a-entity>
        <a-entity id="leftHand" hand-controls="hand: left"></a-entity>
      </a-entity>

      <a-entity
        id="mainEnvironment"
        environment="preset: osiris;
                     ground: hills; groundColor: #61594e; groundTexture: walkernoise; groundYScale: 2; groundDensity: 64;
                     skyType: atmosphere; skyColor: #87CEEB;
                     lighting: distant; lightPosition: 0 1 -0.2; shadow: true; shadowSize: 1024;
                     fog: 0.2;"
      ></a-entity>

      <a-plane
        position="0 0.05 0"
        rotation="-90 0 0"
        width="100"
        height="100"
        material="shader: standard; color: #1e90ff; opacity: 0.7; transparent: true; metalness: 0.5; roughness: 0.3;"
      ></a-plane>

      <a-entity
        id="mainAmbientSound"
        sound="src: #forestSound; autoplay: true; loop: true; volume: 0.6; positional: false"
      ></a-entity>

      <a-entity
        id="rainParticles"
        particle-system="preset: rain; particleCount: 0; color: #ACDFF9; positionSpread: 50 50 50; maxAge: 1.5; size: 0.1; rotationAngle: 90; velocityFrom: 0 -2 0; velocitySpread: 0.1 0 0.1;"
        position="0 10 0"
      ></a-entity>
      <a-entity
        id="snowParticles"
        particle-system="preset: snow; particleCount: 0; color: #FFFFFF; positionSpread: 50 50 50; maxAge: 5; size: 0.2; rotationAngle: 90; velocityFrom: 0 -0.5 0; velocitySpread: 0.5 0.2 0.5;"
        position="0 10 0"
      ></a-entity>

      <a-box
        class="regionTrigger"
        id="fogZone"
        position="10 2 -30"
        width="30"
        height="10"
        depth="30"
        material="opacity: 0; transparent: true;"
        visible="false"
      ></a-box>

      <a-box
        position="0 1.5 -5"
        color="#4CC3D9"
        scale="0.5 0.5 0.5"
        raycaster-target
      ></a-box>

      <script>
        // Store references to elements
        const sceneEl = document.querySelector('a-scene');
        const playerRig = document.getElementById('playerRig');
        const rightHand = document.getElementById('rightHand');
        const mainEnvironment = document.getElementById('mainEnvironment');
        const mainAmbientSound = document.getElementById('mainAmbientSound');
        const rainParticles = document.getElementById('rainParticles');
        const snowParticles = document.getElementById('snowParticles');

        let currentWeather = 'clear'; // 'clear', 'rain', 'snow'
        let isDay = true; // For day/night cycle state
        let dayCycleInterval = null; // To hold the interval for day/night animation

        // --- Day/Night Cycle Component ---
        AFRAME.registerComponent('day-night-cycle', {
          schema: {
            duration: { type: 'number', default: 120000 }, // Duration for full cycle in ms (2 minutes)
          },
          init: function () {
            this.time = 0;
            this.updateLightAndSky = this.updateLightAndSky.bind(this);
            this.playDayCycle(); // Start immediately
          },
          playDayCycle: function () {
            // Clear any existing interval to prevent duplicates
            if (dayCycleInterval) {
              clearInterval(dayCycleInterval);
            }
            // Update every ~100ms for smooth transition but not too frequent
            dayCycleInterval = setInterval(this.updateLightAndSky, 100);
          },
          updateLightAndSky: function () {
            this.time += 100; // Increment time
            if (this.time > this.data.duration) {
              this.time = 0; // Loop back
            }

            const progress = this.time / this.data.duration; // 0 to 1
            const angle = progress * Math.PI * 2; // Full 360 degrees in radians

            // Calculate light position based on angle
            // y: controls sun elevation (1 = high noon, -1 = midnight)
            // z: slight horizontal movement for realism
            const lightY = Math.sin(angle);
            const lightZ = Math.cos(angle) * 0.2; // Small horizontal spread

            // Update environment component's lightPosition
            mainEnvironment.setAttribute('environment', 'lightPosition', `0 ${lightY.toFixed(3)} ${lightZ.toFixed(3)}`);

            // Adjust sky color based on lightY (for atmospheric feel)
            let skyColor;
            if (lightY > 0.5) { // Day
              skyColor = '#87CEEB'; // Light blue
              isDay = true;
            } else if (lightY > -0.5) { // Dusk/Dawn
              // Interpolate between day and night colors
              const ratio = (lightY + 0.5) / 1;
              const r = 135 + (255 - 135) * ratio; // From 135 (night blue) to 255 (day blue)
              const g = 206 + (170 - 206) * ratio; // From 206 to 170
              const b = 235 + (255 - 235) * ratio;
              skyColor = `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`;
              isDay = (lightY > 0); // Still considered day if light is rising
            } else { // Night
              skyColor = '#303050'; // Dark blue/purple for night
              isDay = false;
            }
            // Update the skyColor attribute of the environment component
            mainEnvironment.setAttribute('environment', 'skyColor', skyColor);

            // Adjust fog density for night time or general atmosphere if needed
            // For simplicity, we'll keep fog consistent for now, but could tie to isDay
          }
        });

        // Attach the day-night-cycle component to the scene
        sceneEl.setAttribute('day-night-cycle', 'duration: 60000'); // 1 minute for a faster demo cycle

        // --- Weather Control Function ---
        function setWeather(mode) {
          // Reset all weather effects
          rainParticles.setAttribute('particle-system', 'particleCount', 0);
          snowParticles.setAttribute('particle-system', 'particleCount', 0);
          mainAmbientSound.components.sound.stopSound(); // Stop forest sound temporarily

          // Apply new weather mode
          if (mode === 'rain') {
            rainParticles.setAttribute('particle-system', 'particleCount', 7000); // [cite: 850]
            mainAmbientSound.components.sound.setVolume(0.3); // Muffle forest sound
            document.getElementById('rainSound').components.sound.playSound(); // Play rain sound [cite: 838]
            // Darken sky for cloudy effect [cite: 844]
            mainEnvironment.setAttribute('environment', 'skyColor', '#777'); // [cite: 838]
          } else if (mode === 'snow') {
            snowParticles.setAttribute('particle-system', 'particleCount', 1500); // [cite: 851]
            mainAmbientSound.components.sound.setVolume(0.3); // Muffle forest sound
            document.getElementById('snowSound').components.sound.playSound(); // Play snow sound [cite: 839]
            // Lighten sky for snowy overcast effect
            mainEnvironment.setAttribute('environment', 'skyColor', '#AAAAAA'); // [cite: 839]
          } else { // 'clear'
            mainAmbientSound.components.sound.setVolume(0.6); // Restore forest sound volume
            mainAmbientSound.components.sound.playSound(); // Restart forest sound
            // Revert sky color to day or night based on current cycle
            const currentLightY = mainEnvironment.getAttribute('environment').lightPosition.y;
            if (currentLightY > 0) { // Day
                mainEnvironment.setAttribute('environment', 'skyColor', '#87CEEB');
            } else { // Night
                mainEnvironment.setAttribute('environment', 'skyColor', '#303050');
            }
          }
          currentWeather = mode;
        }

        // --- Controller Input for Weather Toggle ---
        rightHand.addEventListener('abuttondown', () => { // Use 'A' button on right controller [cite: 872]
          if (currentWeather === 'clear') {
            setWeather('rain');
          } else if (currentWeather === 'rain') {
            setWeather('snow');
          } else {
            setWeather('clear');
          }
        });

        // --- Region-Based Fog Effect ---
        playerRig.addEventListener('hitstart', (evt) => {
          const hitEl = evt.detail.intersectedEls && evt.detail.intersectedEls[0];
          if (hitEl && hitEl.id === 'fogZone') { // Check if the hit element is our fog zone [cite: 861]
            sceneEl.setAttribute('fog', 'density: 0.01; color: #889'); // Thicker fog [cite: 861, 865]
            mainAmbientSound.components.sound.setVolume(0.3); // Muffle ambient sound [cite: 861, 866]
          }
        });

        playerRig.addEventListener('hitend', (evt) => {
          const clearedEl = evt.detail.intersectedEls && evt.detail.intersectedEls[0]; // For hitend, check which element was cleared [cite: 864]
          if (clearedEl && clearedEl.id === 'fogZone') {
            sceneEl.setAttribute('fog', 'density: 0.001; color: #DDEEFF'); // Revert to default fog [cite: 862, 865]
            mainAmbientSound.components.sound.setVolume(0.6); // Restore ambient sound volume [cite: 862, 866]
          }
        });

        // Initial weather setup
        setWeather('clear'); // Start with clear weather

      </script>
    </a-scene>
  </body>
</html>
