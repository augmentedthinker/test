<!DOCTYPE html>
<html>
<head>
  <title>VR Space</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/aframe-particle-system-component@1.0.9/dist/aframe-particle-system-component.min.js"></script>
</head>
<body>
  <audio id="clickSound" src="https://cdn.glitch.com/8d718063-48d1-444c-9636-33c7a97f9133%2Fclick.mp3?v=1632427939399" preload="auto"></audio>
  <audio id="explosionSound" src="https://cdn.glitch.com/8d718063-48d1-444c-9636-33c7a97f9133%2Fexplosion.mp3?v=1632427943278" preload="auto"></audio>

  <a-scene>
    <!-- Camera and controllers -->
    <a-entity id="cameraRig" position="0 1.6 0">
      <a-entity id="camera" camera look-controls></a-entity>
      <a-entity id="leftHand" oculus-touch-controls="hand: left" laser-controls="hand: left; color: #ff0000"></a-entity>
      <a-entity id="rightHand" oculus-touch-controls="hand: right" laser-controls="hand: right; color: #0000ff"></a-entity>
    </a-entity>

    <!-- Clickable sphere -->
    <a-sphere id="clickableSphere" position="0 2 -2" radius="0.2" color="#ffff00" clickable>
    </a-sphere>

    <!-- Player sphere -->
    <a-sphere id="playerSphere" radius="0.1" color="#00ff00">
    </a-sphere>

    <!-- Projectile template -->
    <a-entity id="projectileTemplate" visible="false">
        <a-sphere radius="0.05" color="#ff00ff"></a-sphere>
    </a-entity>

    <a-sky color="#222"></a-sky>

  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const clickSound = document.getElementById('clickSound');
      const explosionSound = document.getElementById('explosionSound');
      const clickableSphere = document.getElementById('clickableSphere');
      const playerSphere = document.getElementById('playerSphere');
      const leftHand = document.getElementById('leftHand');
      const rightHand = document.getElementById('rightHand');
      const scene = document.querySelector('a-scene');

      // Update player sphere position
      function updatePlayerSpherePosition() {
        const leftPosition = new THREE.Vector3();
        const rightPosition = new THREE.Vector3();
        leftHand.object3D.getWorldPosition(leftPosition);
        rightHand.object3D.getWorldPosition(rightPosition);
        const centerPosition = new THREE.Vector3().addVectors(leftPosition, rightPosition).multiplyScalar(0.5);
        playerSphere.setAttribute('position', centerPosition);
      }

      // Click event for the sphere
      clickableSphere.addEventListener('click', () => {
        clickSound.play();
        clickableSphere.setAttribute('color', `#${Math.floor(Math.random()*16777215).toString(16)}`);

        const projectile = document.getElementById('projectileTemplate').cloneNode(true);
        projectile.setAttribute('visible', true);
        const startPosition = clickableSphere.getAttribute('position');
        projectile.setAttribute('position', startPosition);

        const leftPosition = new THREE.Vector3();
        const rightPosition = new THREE.Vector3();
        leftHand.object3D.getWorldPosition(leftPosition);
        rightHand.object3D.getWorldPosition(rightPosition);
        const targetPosition = new THREE.Vector3().addVectors(leftPosition, rightPosition).multiplyScalar(0.5);

        projectile.setAttribute('animation', {
          property: 'position',
          to: `${targetPosition.x} ${targetPosition.y} ${targetPosition.z}`,
          dur: 1000,
          easing: 'linear'
        });

        scene.appendChild(projectile);

        // Projectile collision check
        let collisionCheck = setInterval(() => {
            const projectilePosition = projectile.object3D.position;
            const playerPosition = playerSphere.object3D.position;
            const distance = projectilePosition.distanceTo(playerPosition);

            if (distance < playerSphere.getAttribute('radius')) {
                explosionSound.play();
                if (navigator.getGamepads) {
                    const gamepads = navigator.getGamepads();
                    for (const gamepad of gamepads) {
                        if (gamepad && gamepad.hapticActuators) {
                            gamepad.hapticActuators[0].pulse(1, 200);
                        }
                    }
                }

                const explosion = document.createElement('a-entity');
                explosion.setAttribute('position', playerPosition);
                explosion.setAttribute('particle-system', {
                    preset: 'snow',
                    color: '#ff0000,#ffff00,#0000ff',
                    particleCount: 5000,
                    size: 0.2,
                    maxAge: 2,
                    velocityValue: '5 5 5',
                    velocitySpread: '10 10 10',
                    accelerationValue: '0 -10 0',
                    accelerationSpread: '5 5 5'
                });
                scene.appendChild(explosion);

                setTimeout(() => {
                    scene.removeChild(explosion);
                }, 2000);

                scene.removeChild(projectile);
                clearInterval(collisionCheck);
            }
        }, 50);

        setTimeout(() => {
            try {
              scene.removeChild(projectile);
              clearInterval(collisionCheck);
            } catch(e) {}
        }, 1000);
      });

      // Continuously update player sphere position
      setInterval(updatePlayerSpherePosition, 10);
    });

    AFRAME.registerComponent('clickable', {
        init: function () {
            this.el.addEventListener('mousedown', (e) => {
                this.el.emit('click', e, false);
            });
        }
    });
  </script>
</body>
</html>
