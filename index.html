<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Quest VR: Sphere Shooting Game (Prototype)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
</head>
<body>
<a-scene background="color: #ECECEC">
  <a-assets></a-assets>
  <a-entity id="cameraRig" position="0 1.6 0" movement-controls>
    <a-entity id="playerCam" camera look-controls wasd-controls position="0 0 0"></a-entity>
    <a-entity id="leftHand"
              meta-touch-controls="hand: left; model: true"
              laser-controls="hand: left"
              raycaster="objects: .clickable; far: 100"
              line="color: blue; opacity: 0.9"></a-entity>
    <a-entity id="rightHand"
              meta-touch-controls="hand: right; model: true"
              laser-controls="hand: right"
              raycaster="objects: .clickable; far: 100"
              line="color: red; opacity: 0.9"></a-entity>
  </a-entity>
  <a-sky color="#B3E0FF"></a-sky>
  <a-plane id="ground" color="#7BC8A4" rotation="-90 0 0" width="20" height="20"></a-plane>
  <a-entity light="type: ambient; color: #FFF; intensity: 0.8"></a-entity>
  <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="1 3 2"></a-entity>
  <!-- Main clickable sphere -->
  <a-sphere id="colorSphere"
            class="clickable"
            position="0 2 0"
            radius="0.4"
            color="#FFC300"
            shadow="cast: true"
            toggle-color-on-click
            shoot-on-click></a-sphere>

  <script>
    // Sphere color toggle as before
    AFRAME.registerComponent('toggle-color-on-click', {
      schema: {
        colors: {type: 'array', default: ['#FFC300', '#32CD32', '#1976D2', '#E53935']}
      },
      init: function () {
        this.colorIndex = 0;
        this.el.addEventListener('click', () => {
          this.colorIndex = (this.colorIndex + 1) % this.data.colors.length;
          this.el.setAttribute('color', this.data.colors[this.colorIndex]);
        });
      }
    });

    // This component spawns a projectile sphere toward the player when the main sphere is clicked
    AFRAME.registerComponent('shoot-on-click', {
      schema: {
        speed: {type: 'number', default: 1.5}
      },
      init: function () {
        this.el.addEventListener('click', () => {
          // Get player's (camera rig's) world position
          var rig = document.querySelector('#cameraRig');
          var rigPos = new THREE.Vector3();
          rig.object3D.getWorldPosition(rigPos);

          // Get the shooting sphere's position
          var origin = new THREE.Vector3();
          this.el.object3D.getWorldPosition(origin);

          // Calculate direction vector (normalized)
          var direction = rigPos.clone().sub(origin).normalize();

          // Create the projectile
          var scene = this.el.sceneEl;
          var projectile = document.createElement('a-sphere');
          projectile.setAttribute('radius', 0.12);
          projectile.setAttribute('color', '#E53935');
          projectile.setAttribute('position', `${origin.x} ${origin.y} ${origin.z}`);
          projectile.setAttribute('projectile-move', {
            direction: `${direction.x} ${direction.y} ${direction.z}`,
            speed: this.data.speed
          });
          scene.appendChild(projectile);
        });
      }
    });

    // Moves the spawned projectile every frame toward the given direction
    AFRAME.registerComponent('projectile-move', {
      schema: {
        direction: {type: 'string', default: '0 0 0'},
        speed: {type: 'number', default: 1.5}
      },
      init: function () {
        var d = this.data.direction.split(' ').map(Number);
        this.directionVec = new THREE.Vector3(d[0], d[1], d[2]);
        this.speed = this.data.speed;
        this.start = null;
      },
      tick: function (time, deltaTime) {
        if (!this.start) this.start = time;
        var move = this.directionVec.clone().multiplyScalar(this.speed * deltaTime / 1000);
        this.el.object3D.position.add(move);

        // Optional: Remove the projectile after 8 seconds (to keep things clean)
        if (time - this.start > 8000) this.el.parentNode.removeChild(this.el);
      }
    });
  </script>
</a-scene>
</body>
</html>
